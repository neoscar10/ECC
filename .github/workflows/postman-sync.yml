name: Sync Postman Collection

on:
  push:
    branches: ["main"]
    paths:
      - "postman/**"
      - ".github/workflows/postman-sync.yml"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Postman collection
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_COLLECTION_UID: ${{ secrets.POSTMAN_COLLECTION_UID }}
        run: |
          set -euo pipefail

          test -f postman/ECC_API_v1.postman_collection.json

          # Build payload without jq
          printf '{"collection":%s}\n' "$(cat postman/ECC_API_v1.postman_collection.json)" > /tmp/collection.json

          curl --fail-with-body -sS -X PUT "https://api.getpostman.com/collections/${POSTMAN_COLLECTION_UID}" \
            -H "X-Api-Key: ${POSTMAN_API_KEY}" \
            -H "Content-Type: application/json" \
            --data-binary "@/tmp/collection.json"

      - name: Update Postman environment (optional)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_ENV_UID: ${{ secrets.POSTMAN_ENV_UID }}
        run: |
          set -euo pipefail

          if [ -z "${POSTMAN_ENV_UID:-}" ]; then
            echo "POSTMAN_ENV_UID not set. Skipping environment sync."
            exit 0
          fi

          test -f postman/ECC_Local.postman_environment.json

          # Build payload without jq
          printf '{"environment":%s}\n' "$(cat postman/ECC_Local.postman_environment.json)" > /tmp/environment.json

          curl --fail-with-body -sS -X PUT "https://api.getpostman.com/environments/${POSTMAN_ENV_UID}" \
            -H "X-Api-Key: ${POSTMAN_API_KEY}" \
            -H "Content-Type: application/json" \
            --data-binary "@/tmp/environment.json"
